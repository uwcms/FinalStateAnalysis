'''

Class which figures out the correct PU weight.
Takes as input a MC PU tag (i.e. 'S7') and a set of .root files with the
pileup distributions (generated by pileupCalc.py [1])

[1] https://twiki.cern.ch/twiki/bin/view/CMS/PileupJSONFileforData

Author: Evan K. Friis, UW

'''

import array
from FinalStateAnalysis.Utilities.FileInPath import FileInPath
import ROOT
from rootpy.io import root_open
# MC distributions (built at bottom of file)
_MC_PU_DISTRIBUTIONS = {}

class PileupWeight(object):
    def __init__(self, mctag, *datafiles):
        '''
        Build a PU weight object.

        [mctag] must reflect the PU distribution used in simulation and
        currently be either 'S6' or 'S10'.

        [datafiles] is a list of .root files generated a la

        https://twiki.cern.ch/twiki/bin/view/CMS/PileupJSONFileforData

        Note that for 7TeV data there must be 500 bins (0-50) and for 8TeV there
        should 600 bins (0-60)

        '''
        ROOT.TH1.AddDirectory(False)
        self.mc = None
        self.data = None
        
        for filename in datafiles:
            file = root_open(filename)
            pu = file.Get('pileup')
            if self.data is None:
                self.data = pu.Clone()
                self.data.SetDirectory(0)
            else:
                self.data.Add(pu)
            file.Close()
        # Normalize
        self.data.Scale(1./self.data.Integral())
        print 'scaling data'
        if not mctag in _MC_PU_DISTRIBUTIONS:
            raise KeyError("Unknown PU distribution %s, allowed: %s" %
                           (mctag, " ".join(_MC_PU_DISTRIBUTIONS.keys())))
        mc_file =root_open(_MC_PU_DISTRIBUTIONS[mctag])
        if not mc_file:
            raise IOError("Can't open %s MC file: %s" % (mctag, _MC_PU_DISTRIBUTIONS[mctag]))

        mc_base = mc_file.Get('pileup')
        self.mc = mc_base.Clone()
        self.mc.SetName('pileup_mc')
        
        # Make sure bins are consistent
        if not ROOT.TEfficiency.CheckBinning(self.mc, self.data):
            error = "Data and MC PU histograms do not have the same binning!\n"
            def print_bins(tag, x):
                return "%s: (%i, %0.1f, %0.1f)" % (
                    tag, x.GetNbinsX(), x.GetXaxis().GetXmin(),
                    x.GetXaxis().GetXmax())
            error += print_bins(mctag, self.mc)
            error += "\n"
            error += print_bins('data', self.data)
            raise ValueError(error)
       # Normalize MC
        self.mc.Scale(1./self.mc.Integral())
        ROOT.TH1.AddDirectory(True)
        
    def __call__(self, ntruepu):
        '''
        Get the PU weight given the true number of interactions
        '''
        bin = self.data.FindBin(ntruepu)
        data = self.data.GetBinContent(bin)
        mc = self.mc.GetBinContent(bin)
        if mc:
            return data/mc
        else:
            return 1.0

_MC_PU_DISTRIBUTIONS['DY'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupDY.root").full_path()
_MC_PU_DISTRIBUTIONS['DY1'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupDY1.root").full_path()
_MC_PU_DISTRIBUTIONS['DY2'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupDY2.root").full_path()
_MC_PU_DISTRIBUTIONS['DY3'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupDY3.root").full_path()
_MC_PU_DISTRIBUTIONS['DY4'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupDY4.root").full_path()
_MC_PU_DISTRIBUTIONS['DY10'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupDY10.root").full_path()
_MC_PU_DISTRIBUTIONS['W'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupW.root").full_path()
_MC_PU_DISTRIBUTIONS['W1'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupW1.root").full_path()
_MC_PU_DISTRIBUTIONS['W2'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupW2.root").full_path()
_MC_PU_DISTRIBUTIONS['W3'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupW3.root").full_path()
_MC_PU_DISTRIBUTIONS['W4'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupW4.root").full_path()
_MC_PU_DISTRIBUTIONS['WW'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupWW.root").full_path()
_MC_PU_DISTRIBUTIONS['WZ'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupWZ.root").full_path()
_MC_PU_DISTRIBUTIONS['ZZ'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupZZ.root").full_path()
_MC_PU_DISTRIBUTIONS['Wminus'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupEWKWminus.root").full_path()
_MC_PU_DISTRIBUTIONS['Wplus'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupEWKWplus.root").full_path()
_MC_PU_DISTRIBUTIONS['Zll'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupEWKZll.root").full_path()
_MC_PU_DISTRIBUTIONS['Znunu'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupEWKZnunu.root").full_path()
_MC_PU_DISTRIBUTIONS['STtantitop'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupSTtantitop.root").full_path()
_MC_PU_DISTRIBUTIONS['STttop'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupSTttop.root").full_path()
_MC_PU_DISTRIBUTIONS['STtWantitop'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupSTtWantitop.root").full_path()
_MC_PU_DISTRIBUTIONS['STtWtop'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupSTtWtop.root").full_path()
_MC_PU_DISTRIBUTIONS['TTTo2L2Nu'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupTTTo2L2Nu.root").full_path()
_MC_PU_DISTRIBUTIONS['TTToHadronic'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupTTToHadronic.root").full_path()
_MC_PU_DISTRIBUTIONS['TTToSemiLeptonic'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupTTToSemiLeptonic.root").full_path()
_MC_PU_DISTRIBUTIONS['VBFHMT'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupVBFHMT.root").full_path()
_MC_PU_DISTRIBUTIONS['VBFHTT'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupVBFHTT.root").full_path()
_MC_PU_DISTRIBUTIONS['GGHMT'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupGGHMT.root").full_path()
_MC_PU_DISTRIBUTIONS['GGHTT'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupGGHTT.root").full_path()
_MC_PU_DISTRIBUTIONS['ZHTT'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupZHTT.root").full_path()
_MC_PU_DISTRIBUTIONS['ttH'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupttH.root").full_path()
_MC_PU_DISTRIBUTIONS['WminusHTT'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupWminusHTT.root").full_path()
_MC_PU_DISTRIBUTIONS['WplusHTT'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupWplusHTT.root").full_path()
_MC_PU_DISTRIBUTIONS['QCD'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupQCD.root").full_path()
_MC_PU_DISTRIBUTIONS['DYAMC'] = FileInPath("FinalStateAnalysis/TagAndProbe/data/pileupDYAMC.root").full_path()
